// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL –° RENDER
const BACKEND_URL = 'https://b828b8021cb6cee2539b33ff1876e0c7.serveo.net'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL

// –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
let currentSettings = {
    quality: 'lossless',
    format: '1x1',
    sendAs: 'video',
    file: null,
    processedBlob: null
};

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
let stats = {
    processed: 0,
    aiEnhanced: 0,
    timeSaved: 0,
    users: 1
};

// –¢–∞–π–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
let processTimer = null;
let startTime = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    setupEventListeners();
    checkBackendConnection();
});

function setupEventListeners() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleFileDrop);
    uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());

    // –ö–∞—á–µ—Å—Ç–≤–æ
    document.querySelectorAll('.quality-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSettings.quality = this.dataset.quality;
        });
    });

    // –§–æ—Ä–º–∞—Ç—ã
    document.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSettings.format = this.dataset.format;
        });
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.getElementById('enhance4kBtn').addEventListener('click', () => processWithMode('enhance_4k'));
    document.getElementById('interpolateBtn').addEventListener('click', () => processWithMode('interpolate'));
    
    document.getElementById('sendAsVideoBtn').addEventListener('click', function() {
        currentSettings.sendAs = 'video';
        this.classList.add('active');
        document.getElementById('sendAsFileBtn').classList.remove('active');
    });
    
    document.getElementById('sendAsFileBtn').addEventListener('click', function() {
        currentSettings.sendAs = 'file';
        this.classList.add('active');
        document.getElementById('sendAsVideoBtn').classList.remove('active');
    });

    // –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    document.getElementById('processBtn').addEventListener('click', processVideo);
    document.getElementById('downloadBtn').addEventListener('click', downloadResult);
    document.getElementById('processAnotherBtn').addEventListener('click', resetToUpload);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        loadVideoFile(file);
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#6366f1';
    event.currentTarget.style.background = '#f0f4ff';
}

function handleDragLeave(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#6366f1';
    event.currentTarget.style.background = '#f8faff';
}

function handleFileDrop(event) {
    event.preventDefault();
    const file = event.dataTransfer.files[0];
    if (file) {
        loadVideoFile(file);
    }
    handleDragLeave(event);
}

function loadVideoFile(file) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (100MB –º–∞–∫—Å–∏–º—É–º)
    if (file.size > 100 * 1024 * 1024) {
        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB');
        return;
    }

    currentSettings.file = file;
    const videoPreview = document.getElementById('videoPreview');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const fileInfo = document.getElementById('fileInfo');
    
    videoPreview.src = URL.createObjectURL(file);
    videoPreview.style.display = 'block';
    previewPlaceholder.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
    fileInfo.textContent = `${file.name} (${fileSize} MB)`;
    fileInfo.style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
    document.getElementById('downloadSection').style.display = 'none';
}

async function processVideo() {
    await processWithMode('stretch');
}

async function processWithMode(mode) {
    if (!currentSettings.file) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª!');
        return;
    }

    showProcessing(mode);

    const formData = new FormData();
    formData.append('video', currentSettings.file);
    formData.append('quality', currentSettings.quality);
    formData.append('format', currentSettings.format);
    formData.append('mode', mode);

    try {
        const response = await fetch(`${BACKEND_URL}/api/process`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
            // –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const downloadResponse = await fetch(`${BACKEND_URL}${result.download_url}`);
            if (!downloadResponse.ok) {
                throw new Error('Failed to download processed video');
            }
            
            const blob = await downloadResponse.blob();
            showRealResult(blob, result.message);
        } else {
            throw new Error(result.error || 'Unknown error occurred');
        }
    } catch (error) {
        console.error('Processing error:', error);
        hideProcessing();
        alert(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
    }
}

function showProcessing(mode) {
    const overlay = document.getElementById('processingOverlay');
    const title = document.getElementById('processingTitle');
    const text = document.getElementById('processingText');
    
    const modes = {
        stretch: { 
            title: 'üîÑ –†–∞—Å—Ç—è–≥–∏–≤–∞—é –≤–∏–¥–µ–æ...', 
            text: '–ò–∑–º–µ–Ω—è—é —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∫–∞—á–µ—Å—Ç–≤–∞' 
        },
        enhance_4k: { 
            title: 'üöÄ –£–ª—É—á—à–∞—é –¥–æ 4K...', 
            text: 'AI-—É–ª—É—á—à–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –¥–µ—Ç–∞–ª–µ–π' 
        },
        interpolate: { 
            title: 'üé¨ –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É—é –∫–∞–¥—Ä—ã...', 
            text: '–°–æ–∑–¥–∞—é –ø–ª–∞–≤–Ω–æ—Å—Ç—å 120FPS' 
        },
        ai_enhance: { 
            title: 'ü§ñ AI-—É–ª—É—á—à–µ–Ω–∏–µ...', 
            text: '–ù–µ–π—Ä–æ—Å–µ—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–¥ –∫–∞—á–µ—Å—Ç–≤–æ–º' 
        }
    };
    
    const modeConfig = modes[mode] || modes.stretch;
    title.textContent = modeConfig.title;
    text.textContent = modeConfig.text;
    overlay.style.display = 'flex';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    document.getElementById('processingTime').textContent = '';
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    startTime = Date.now();
    updateProcessingTime();
    processTimer = setInterval(updateProcessingTime, 1000);
    
    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å –±—ç–∫–µ–Ω–¥–∞)
    simulateProgress();
}

function updateProcessingTime() {
    if (!startTime) return;
    
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('processingTime').textContent = 
        `–ü—Ä–æ—à–ª–æ: ${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function simulateProgress() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += Math.random() * 8;
        if (progress >= 95) {
            progress = 95; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ 95% –¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        }
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
    }, 500);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
    currentSettings.progressInterval = interval;
}

function hideProcessing() {
    const overlay = document.getElementById('processingOverlay');
    overlay.style.display = 'none';
    
    if (processTimer) {
        clearInterval(processTimer);
        processTimer = null;
    }
    
    if (currentSettings.progressInterval) {
        clearInterval(currentSettings.progressInterval);
        currentSettings.progressInterval = null;
    }
}

function showRealResult(blob, message) {
    hideProcessing();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 100% –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('progressText').textContent = '100%';
    
    document.getElementById('downloadSection').style.display = 'block';
    
    const resultVideo = document.getElementById('resultVideo');
    resultVideo.src = URL.createObjectURL(blob);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    currentSettings.processedBlob = blob;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (currentSettings.quality === 'ai') {
        stats.aiEnhanced++;
    }
    stats.processed++;
    stats.timeSaved += 3;
    updateStats();
    saveStats();
}

function downloadResult() {
    if (currentSettings.processedBlob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(currentSettings.processedBlob);
        link.download = `processed_${currentSettings.format}_${Date.now()}.mp4`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function resetToUpload() {
    document.getElementById('downloadSection').style.display = 'none';
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('videoPreview').style.display = 'none';
    document.getElementById('previewPlaceholder').style.display = 'flex';
    
    currentSettings.file = null;
    currentSettings.processedBlob = null;
}

async function checkBackendConnection() {
    try {
        const response = await fetch(`${BACKEND_URL}/api/health`);
        if (response.ok) {
            console.log('Backend connection: OK');
        } else {
            console.warn('Backend connection: Weak');
        }
    } catch (error) {
        console.error('Backend connection: FAILED -', error.message);
    }
}

function loadStats() {
    const savedStats = localStorage.getItem('videoEditorStats');
    if (savedStats) {
        stats = JSON.parse(savedStats);
    }
    updateStats();
}

function updateStats() {
    document.getElementById('processedCount').textContent = stats.processed;
    document.getElementById('aiEnhancedCount').textContent = stats.aiEnhanced;
    document.getElementById('timeSaved').textContent = stats.timeSaved;
    document.getElementById('userCount').textContent = stats.users;
}

function saveStats() {
    localStorage.setItem('videoEditorStats', JSON.stringify(stats));
}

// –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
setTimeout(() => {
    document.querySelectorAll('.control-section').forEach((section, index) => {
        setTimeout(() => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            section.style.transition = 'all 0.5s ease';
            setTimeout(() => {
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
}, 500);
